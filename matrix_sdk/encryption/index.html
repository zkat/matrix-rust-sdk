<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="End-to-end encryption related types"><meta name="keywords" content="rust, rustlang, rust-lang, encryption"><title>matrix_sdk::encryption - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" type="text/css" href="../../normalize.css"><link rel="stylesheet" type="text/css" href="../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../../ayu.css" disabled><link rel="stylesheet" type="text/css" href="../../dark.css" disabled><link rel="stylesheet" type="text/css" href="../../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../../storage.js"></script><script src="../../crates.js"></script><script defer src="../../main.js"></script>
    <noscript><link rel="stylesheet" href="../../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../../favicon.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../../matrix_sdk/index.html"><div class="logo-container"><img class="rust-logo" src="../../rust-logo.svg" alt="logo"></div>
        </a><h2 class="location"></h2>
    </nav>
    <nav class="sidebar"><a class="sidebar-logo" href="../../matrix_sdk/index.html"><div class="logo-container"><img class="rust-logo" src="../../rust-logo.svg" alt="logo"></div>
        </a><h2 class="location"><a href="#">Module encryption</a></h2><div class="sidebar-elems"><section><div class="block"><ul><li><a href="#modules">Modules</a></li><li><a href="#structs">Structs</a></li><li><a href="#enums">Enums</a></li></ul></div></section><div id="sidebar-vars" data-name="encryption" data-ty="mod" data-relpath="./"></div><script defer src="./sidebar-items.js"></script></div></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../../matrix_sdk/index.html"><img class="rust-logo" src="../../rust-logo.svg" alt="logo"></a><nav class="sub"><div class="theme-picker hidden"><button id="theme-picker" aria-label="Pick another theme!" aria-haspopup="menu" title="themes"><img width="22" height="22" alt="Pick another theme!" src="../../brush.svg"></button><div id="theme-choices" role="menu"></div></div><form class="search-form"><div class="search-container"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><button type="button" id="help-button" title="help">?</button><a id="settings-menu" href="../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../wheel.svg"></a></div></form></nav></div><section id="main-content" class="content"><div class="main-heading">
    <h1 class="fqn"><span class="in-band">Module <a href="../index.html">matrix_sdk</a>::<wbr><a class="mod" href="#">encryption</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../../clipboard.svg" width="19" height="18" alt="Copy item path"></button></span></h1><span class="out-of-band"><a class="srclink" href="../../src/matrix_sdk/encryption/mod.rs.html#16-944">source</a> · <a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span></div><span class="item-info"><div class="stab portability">Available on <strong>crate feature <code>e2e-encryption</code></strong> only.</div></span><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>End-to-end encryption related types</p>
<p>Matrix has support for end-to-end encrypted messaging, this module contains
types related to end-to-end encryption, describes a bit how E2EE works in
the matrix-sdk, and how to set your <a href="../struct.Client.html" title="Client"><code>Client</code></a> up to support E2EE.</p>
<p>Jump to the <a href="#client-setup">Client Setup</a> section if you don’t care how E2EE
works under the hood.</p>
<h2 id="end-to-end-encryption"><a href="#end-to-end-encryption">End-to-end encryption</a></h2>
<p>While all messages in Matrix land are transferred to the server in an
encrypted manner, rooms can be marked as end-to-end encrypted. If a room is
marked as end-to-end encrypted, using a <code>m.room.encrypted</code> state event, all
messages that are sent to this room will be encrypted for the individual
room members. This means that the server won’t be able to read messages that
get sent to such a room.</p>
<div class="example-wrap"><pre class="language-text"><code>                              ┌──────────────┐
                              │  Homeserver  │
     ┌───────┐                │              │                ┌───────┐
     │ Alice │═══════════════►│  unencrypted │═══════════════►│  Bob  │
     └───────┘   encrypted    │              │   encrypted    └───────┘
                              └──────────────┘</code></pre></div><div class="example-wrap"><pre class="language-text"><code>                              ┌──────────────┐
                              │  Homeserver  │
     ┌───────┐                │              │                ┌───────┐
     │ Alice │≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡►│─────────────►│≡≡≡≡≡≡≡≡≡≡≡≡≡≡≡►│  Bob  │
     └───────┘   encrypted    │   encrypted  │   encrypted    └───────┘
                              └──────────────┘</code></pre></div><h3 id="encrypting-for-each-end"><a href="#encrypting-for-each-end">Encrypting for each end</a></h3>
<p>We already mentioned that a message in a end-to-end encrypted world needs to
be encrypted for each individual member, though that isn’t completely
correct. A message needs to be encrypted for each individual <em>end</em>. An <em>end</em>
in Matrix land is a client that communicates with the homeserver. The spec
calls an <em>end</em> a Device, while other clients might call an <em>end</em> a Session.</p>
<p>The matrix-sdk represents an <em>end</em> as a <a href="identities/struct.Device.html" title="Device"><code>Device</code></a> object. Each individual
message should be encrypted for each individual <a href="identities/struct.Device.html" title="Device"><code>Device</code></a> of each
individual room member.</p>
<p>Since rooms might grow quite big, encrypting each message for every
<a href="identities/struct.Device.html" title="Device"><code>Device</code></a> becomes quickly unsustainable. Because of that room keys have
been introduced.</p>
<h3 id="room-keys"><a href="#room-keys">Room keys</a></h3>
<p>Room keys remove the need to encrypt each message for each <em>end</em>.
Instead a room key needs to be shared with each <em>end</em>, after that a message
can be encrypted in a single, O(1), step.</p>
<p>A room key is backed by a <a href="https://gitlab.matrix.org/matrix-org/olm/blob/master/docs/megolm.md">Megolm</a> session, which in turn consists two
parts. The first part, the outbound group session is used for encryption,
this one never leaves your device. The second part is the inbound group
session, which is shared with each <em>end</em>.</p>
<div class="example-wrap"><pre class="language-text"><code>            ┌────────────────────────┬───────────────────────┐
            │       Encryption       │      Decryption       │
            ├────────────────────────┼───────────────────────┤
            │ Outbound group session │ Inbound group session │
            └────────────────────────┴───────────────────────┘</code></pre></div><h4 id="lifetime-of-a-room-key"><a href="#lifetime-of-a-room-key">Lifetime of a room key</a></h4>
<ol>
<li>Create a room key</li>
<li>Share the room key with each participant</li>
<li>Encrypt messages using the room key</li>
<li>If needed, rotate the room key and go back to 1</li>
</ol>
<p>The <code>m.room.encryption</code> state event of the room decides how long a room key
should be used. By default this is for 100 messages or for 1 week, whichever
comes first.</p>
<h4 id="decrypting-the-room-history"><a href="#decrypting-the-room-history">Decrypting the room history</a></h4>
<p>Since room keys get relatively often rotated, each room key will need to be
stored, otherwise we won’t be able to decrypt historical messages. The SDK
stores all room keys locally in a encrypted manner.</p>
<p>Besides storing them as part of the SDK store, users can export room keys
using the <a href="struct.Encryption.html#method.export_keys" title="Encryption::export_keys"><code>Encryption::export_keys</code></a> method.</p>
<h2 id="verification"><a href="#verification">Verification</a></h2>
<p>One important aspect of end-to-end encryption is to check that the <em>end</em> you
are communicating with is indeed the person you expect. This checking is
done in Matrix via interactive verification. While interactively verifying,
we’ll need to exchange some critical piece of information over another
communication channel, over the phone, or in person are good candidates
for such a channel.</p>
<p>Usually each <em>end</em> will need to verify every <em>end</em> it communicates with. An
<em>end</em> is represented as a <a href="identities/struct.Device.html" title="Device"><code>Device</code></a> in the matrix-sdk. This gets rather
complicated quickly as is shown bellow, with Alice and Bob each having two
devices. Each arrow represents who needs to verify whom for the
communication between Alice and Bob to be considered secure.</p>
<div class="example-wrap"><pre class="language-text"><code>
              ┌───────────────────────────────────────────┐
              ▼                                           │
        ┌───────────┐                                ┌────┴────┐
      ┌►│Alice Phone├───────────────────────────────►│Bob Phone│◄──┐
      │ └─────┬─────┘                                └─────┬───┘   │
      │       ▼                                            ▼       │
      │ ┌────────────┐                               ┌───────────┐ │
      └─┤Alice Laptop├──────────────────────────────►│Bob Desktop├─┘
        └────────────┘                               └─────┬─────┘
              ▲                                            │
              └────────────────────────────────────────────┘
</code></pre></div>
<p>To simplify things and lower the amount of devices a user needs to verify
cross signing has been introduced. Cross signing adds a concept of a user
identity which is represented in the matrix-sdk using the <a href="#struct.verification.UserIdentity"><code>UserIdentity</code></a>
struct. This way Alice and Bob only need to verify their own devices and
each others user identity for the communication to be considered secure.</p>
<div class="example-wrap"><pre class="language-text"><code>
           ┌─────────────────────────────────────────────────┐
           │   ┌─────────────────────────────────────────┐   │
           ▼   │                                         ▼   │
    ┌──────────┴─────────┐                   ┌───────────────┴──────┐
    │┌──────────────────┐│                   │  ┌────────────────┐  │
    ││Alice UserIdentity││                   │  │Bob UserIdentity│  │
    │└───┬─────────┬────┘│                   │  └─┬───────────┬──┘  │
    │    │         │     │                   │    │           │     │
    │    ▼         ▼     │                   │    ▼           ▼     │
    │┌───────┐ ┌────────┐│                   │┌───────┐  ┌─────────┐│
    ││ Alice │ │ Alice  ││                   ││  Bob  │  │   Bob   ││
    ││ Phone │ │ Laptop ││                   ││ Phone │  │ Desktop ││
    │└───────┘ └────────┘│                   │└───────┘  └─────────┘│
    └────────────────────┘                   └──────────────────────┘
</code></pre></div>
<p>More info about devices and identities can be found in the <a href="identities/index.html" title="identities"><code>identities</code></a>
module.</p>
<p>To add interactive verification support to your client please see the
<a href="verification/index.html" title="verification"><code>verification</code></a> module, also check out the documentation for the
<a href="identities/struct.Device.html#method.verified" title="Device::verified()"><code>Device::verified()</code></a> method, which explains in more detail what it means
for a <a href="identities/struct.Device.html" title="Device"><code>Device</code></a> to be verified.</p>
<h2 id="client-setup"><a href="#client-setup">Client setup</a></h2>
<p>The matrix-sdk aims to provide encryption support transparently. If
encryption is enabled and correctly set up, events that need to be encrypted
will be encrypted automatically. Events will also be decrypted
automatically.</p>
<p>Please note that, unless a client is specifically set up to ignore
unverified devices, verifying devices is <strong>not</strong> necessary for encryption
to work.</p>
<ol>
<li>Make sure the <code>encryption</code> feature is enabled.</li>
<li>To persist the encryption keys, you can use one of the provided backend
constructors as described in the documentation of the <a href="../store/index.html"><code>store</code></a> module or you
can provide your own backend that implements <a href="../../matrix_sdk_crypto/store/trait.CryptoStore.html"><code>CryptoStore</code></a> in a
<a href="../config/struct.StoreConfig.html"><code>StoreConfig</code></a> or via <a href="../struct.ClientBuilder.html#method.crypto_store"><code>ClientBuilder::crypto_store()</code></a>.</li>
</ol>
<h3 id="restoring-a-client"><a href="#restoring-a-client">Restoring a client</a></h3>
<p>Restoring a Client is relatively easy, still some things need to be kept in
mind before doing so.</p>
<p>There are two ways one might wish to restore a <a href="../struct.Client.html" title="Client"><code>Client</code></a>:</p>
<ol>
<li>Using an access token</li>
<li>Using the password</li>
</ol>
<p>Initially, logging in creates a device ID and access token on the server,
those two are directly connected to each other, more on this relationship
can be found in the <a href="https://spec.matrix.org/unstable/client-server-api/#relationship-between-access-tokens-and-devices">spec</a>.</p>
<p>After we log in the client will upload the end-to-end encryption related
<a href="https://spec.matrix.org/unstable/client-server-api/#device-keys">device keys</a> to the server. Those device keys cannot be replaced once they
have been uploaded and tied to a device ID.</p>
<h4 id="using-an-access-token"><a href="#using-an-access-token">Using an access token</a></h4>
<ol>
<li>Log in with the password using <a href="../struct.Client.html#method.login" title="Client::login()"><code>Client::login()</code></a> setting the
<code>device_id</code> argument to <code>None</code>.</li>
<li>Store the access token, preferably somewhere secure.</li>
<li>Use <a href="../struct.Client.html#method.restore_login" title="Client::restore_login()"><code>Client::restore_login()</code></a> the next time the client starts.</li>
</ol>
<p><strong>Note</strong> that the access token is directly connected to a device ID that
lives on a server. If you’re skipping step one of this method, remember that
you <strong>can’t</strong> use an access token that already has some device keys tied to
the device ID.</p>
<h4 id="using-a-password"><a href="#using-a-password">Using a password.</a></h4>
<ol>
<li>Log in using <a href="../struct.Client.html#method.login" title="Client::login()"><code>Client::login()</code></a> setting the <code>device_id</code> argument to <code>None</code>.</li>
<li>Store the <code>device_id</code> that was returned in the login response from the
server.</li>
<li>Use <a href="../struct.Client.html#method.login" title="Client::login()"><code>Client::login()</code></a> the next time the client starts, make sure to
<strong>set</strong> <code>device_id</code> this time to the stored <code>device_id</code> from the previous
step. This will replace the access token from the previous login call but
won’t create a new device.</li>
</ol>
<p><strong>Note</strong> that the default store supports only a single device, logging in
with a different device id (either <code>None</code> or a device ID of another client)
is <strong>not</strong> supported using the default store.</p>
<h3 id="common-pitfalls"><a href="#common-pitfalls">Common pitfalls</a></h3><div><table><thead><tr><th>Failure</th><th>Cause</th><th>Fix</th></tr></thead><tbody>
<tr><td>No messages get encrypted nor decrypted</td><td>The <code>encryption</code> feature is disabled</td><td><a href="https://doc.rust-lang.org/cargo/reference/specifying-dependencies.html#choosing-features">Enable the feature in your <code>Cargo.toml</code> file</a></td></tr>
<tr><td>Messages that were decryptable aren’t after a restart</td><td>Storage isn’t setup to be persistent</td><td>Ensure you’ve activated the persistent storage backend feature, e.g. <code>sled</code></td></tr>
<tr><td>Messages are encrypted but can’t be decrypted</td><td>The access token that the client is using is tied to another device</td><td>Clear storage to create a new device, read the <a href="#restoring-a-client">Restoring a Client</a> section</td></tr>
<tr><td>Messages don’t get encrypted but get decrypted</td><td>The <code>m.room.encryption</code> event is missing</td><td>Make sure encryption is <a href="../room/struct.Joined.html#method.enable_encryption">enabled</a> for the room and the event isn’t <a href="../config/struct.SyncSettings.html#method.filter">filtered</a> out, otherwise it might be a deserialization bug</td></tr>
</tbody></table>
</div></div></details><h2 id="modules" class="small-section-header"><a href="#modules">Modules</a></h2>
<div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="mod" href="identities/index.html" title="matrix_sdk::encryption::identities mod">identities</a></div><div class="item-right docblock-short"><p>Cryptographic identities used in Matrix.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="mod" href="verification/index.html" title="matrix_sdk::encryption::verification mod">verification</a></div><div class="item-right docblock-short"><p>Interactive verification for E2EE capable users and devices in Matrix.</p>
</div></div></div><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2>
<div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.Encryption.html" title="matrix_sdk::encryption::Encryption struct">Encryption</a></div><div class="item-right docblock-short"><p>A high-level API to manage the client’s encryption.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.MediaEncryptionInfo.html" title="matrix_sdk::encryption::MediaEncryptionInfo struct">MediaEncryptionInfo</a></div><div class="item-right docblock-short"><p>Struct holding all the information that is needed to decrypt an encrypted
file.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.RoomKeyImportResult.html" title="matrix_sdk::encryption::RoomKeyImportResult struct">RoomKeyImportResult</a></div><div class="item-right docblock-short"><p>Return type for the room key importing.</p>
</div></div></div><h2 id="enums" class="small-section-header"><a href="#enums">Enums</a></h2>
<div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.LocalTrust.html" title="matrix_sdk::encryption::LocalTrust enum">LocalTrust</a></div><div class="item-right docblock-short"><p>The local trust state of a device.</p>
</div></div></div></section></div></main><div id="rustdoc-vars" data-root-path="../../" data-current-crate="matrix_sdk" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.62.0-nightly (ecd44958e 2022-05-10)" ></div>
</body></html>